#!/usr/bin/env ruby

# ---
# bin/humidity_control -- Ruby "executable" for monitoring humidity sensors
# ---
require_relative '../lib/humidity_control'

options = {}
OptionParser.new do |opts|
  opts.banner = "\nHumidity Control (c) Michael Schwarze, 2019.\n\n"
  opts.banner << '  Usage: humidity_control [options]'

  options[:format] = 'text'
  opts.on('-h', '--help', 'Display this screen') do
    puts opts
    puts "\n  Configuration:"
    puts '    - (1) file as specified by environment variable HUMIDITY_CONTROL_CONFIG_FILE,'
    puts '    - (2) /data/.config.'
    exit
  end
end.parse!

config = Config.new
sensor = Sensor.new(config: config)

loop do
  message = "ESP32@#{config.sensor_url} "
  begin
    sensor.read
  rescue StandardError => errormsg
    message << "\nSomething went wrong!\n#{errormsg}\n"
  end
  message << "- Type #{sensor.type} - Uptime = #{beautify sensor.uptime} "
  message << "– Warnings = #{sensor.warnings} – Reading is #{sensor.reading}."
  LOGGER.info message
  Alert.new(message: message, level: :alarm, config: config) unless sensor.reading == 'dry'
  Alert.new(message: message, level: :info, config: config) if sensor.new_day?
  sleep 15
end
