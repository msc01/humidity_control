#!/usr/bin/env ruby

# ---
# bin/humidity_control -- Ruby "executable" for monitoring humidity sensors
# ---
# TODO:
# [ ] Deploy and test in production
# [ ] Daily info SMS update
# [ ] Phone call for alarm
# [ ] How to handle repeat alarming?
# ---
require_relative '../lib/humidity_control'

options = {}
OptionParser.new do |opts|
  opts.banner << 'Usage: humidity_control [options]'

  options[:format] = 'text'
  opts.on('-h', '--help', 'Display this screen') do
    puts opts
    exit
  end
end.parse!

sensor = Sensor.new(config: Config.new)

loop do
  message = "ESP32-FC37@#{sensor.url} = "
  begin
    reading = sensor.reading
  rescue StandardError => errormsg
    message << 'Something went wrong!'
    Alert.new message: message, level: :alarm
    LOGGER.warn message << "\n#{errormsg}"
    redo
  end
  message << "Reading is #{reading}."
  LOGGER.info message
  Alert.new(message: message, level: :alarm) unless reading == 'dry'
  sleep 10
end
