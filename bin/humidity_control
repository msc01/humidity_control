#!/usr/bin/env ruby

# ---
# bin/humidity_control -- Ruby "executable" for monitoring humidity sensors
# ---
require_relative '../lib/humidity_control'

options = {}
OptionParser.new do |opts|
  opts.banner << 'Usage: humidity_control [options]'

  options[:format] = 'text'
  opts.on('-h', '--help', 'Display this screen') do
    puts opts
    exit
  end
end.parse!

config = Config.new

loop do
  message = "ESP32-FC37@#{config.url_sensor} "
  begin
    sensor = Sensor.new(config: config)
  rescue StandardError => errormsg
    message << 'Something went wrong!'
    Alert.new message: message, level: :alarm
    LOGGER.warn message << "\n#{errormsg}"
    redo
  end
  message << ": Reading is #{sensor.reading}."
  LOGGER.info message
  Alert.new(message: message, level: :alarm) unless sensor.reading == 'dry'
  sleep 10
end
