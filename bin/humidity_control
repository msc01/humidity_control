#!/usr/bin/env ruby

# ---
# bin/humidity_control -- Ruby "executable" for monitoring humidity sensors
# ---
require_relative '../lib/humidity_control'

options = {}
OptionParser.new do |opts|
  opts.banner = 'Usage: humidity_control [options]'

  options[:format] = 'text'
  opts.on('-h', '--help', 'Display this screen') do
    puts opts
    puts "\nConfiguration: either in /data/.config (2) or environment variable HUMIDITY_CONTROL_CONFIG_FILE (1).\n"
    exit
  end
end.parse!

config = Config.new
sensor = Sensor.new(config: config)

loop do
  message = "ESP32@#{config.url_sensor} "
  begin
    sensor.read
  rescue StandardError => errormsg
    message << "\nSomething went wrong!\n#{errormsg}\n"
  end
  message << <<~TEXT
    - Type #{sensor.type} - Uptime = #{beautify sensor.uptime} â€“ Warnings = #{sensor.warnings} â€“ Reading is #{sensor.reading}.
  TEXT
  LOGGER.info message
  Alert.new(message: message, level: :alarm, config: config) unless sensor.reading == 'dry'
  sleep 10
end
